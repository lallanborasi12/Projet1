pipeline {
    agent any

    stages {
        stage('Clean Workspace') {
            steps {
                echo "Cleaning Jenkins Workspace"
                deleteDir()
            }
        }

        stage('Clone Repo') {
            steps {
                echo "Cloning the repo"
                git branch: 'master', url: 'https://github.com/lallanborasi12/Projet1.git'
            }
        }

        stage('Deploy App1') {
            steps {
                echo "Deploying App1"
                sh '''
                    APP_DIR=/var/www/html3/reactjs-app1
                    APP_NAME=nextjs-app1
                    APP_PORT=3000

                    sudo mkdir -p $APP_DIR
                    sudo chown -R jenkins:jenkins $APP_DIR

                    rsync -av --delete --exclude=.git --exclude=node_modules ./ $APP_DIR

                    cd $APP_DIR
                    npm install
                    npm run build

                    if ! command -v pm2 >/dev/null 2>&1; then
                        sudo npm install -g pm2
                    fi

                    pm2 stop $APP_NAME || true
                    pm2 delete $APP_NAME || true

                    pm2 start "npm run start -- -p $APP_PORT" --name $APP_NAME
                    pm2 save
                '''
            }
        }

        stage('Deploy App2') {
            steps {
                echo "Deploying App2"
                sh '''
                    APP_DIR=/var/www/html3/reactjs-app2
                    APP_NAME=nextjs-app2
                    APP_PORT=3001

                    sudo mkdir -p $APP_DIR
                    sudo chown -R jenkins:jenkins $APP_DIR

                    # üëá yaha aap App2 ka code laane ke liye 
                    # either alag repo clone kijiye OR isi repo me alag folder se rsync karo
                    rsync -av --delete --exclude=.git --exclude=node_modules ./ $APP_DIR

                    cd $APP_DIR
                    npm install
                    npm run build

                    pm2 stop $APP_NAME || true
                    pm2 delete $APP_NAME || true

                    pm2 start "npm run start -- -p $APP_PORT" --name $APP_NAME
                    pm2 save
                '''
            }
        }
    }

    post {
        success {
            echo "‚úÖ Deployment successful! App1:3000, App2:3001"
        }
        failure {
            echo "‚ùå Deployment failed! Check logs."
        }
    }
}
